<tool id="stoceps_glm_group" name="Estimate temporal population evolution" version="@VERSION@">
    <description>by specialization group</description>
    <macros>
        <import>stoceps_macros.xml</import>
    </macros>
    <expand macro="mainglm_requirements"/>
    <command detect_errors="exit_code"><![CDATA[
        Rscript 
         '$__tool_directory__/ExeMainglmParGroupGalaxy.r' 
         '$input_y_var'
         '$input_glob_tendencies'
         '$__tool_directory__/tabSpecies.csv'
         'mainglm_group'
         #if $settings.advanced=='advanced' 
             $settings.sp_code
         #else
             ''
         #end if
         '$__tool_directory__/FunctTrendSTOCGalaxy.r'
         '$__tool_directory__/biais.tabular'
         
        '$data_group'
        '$year_var_group'
        '$glob_tend_group'
    ]]>
    </command>
    <inputs>
        <param name="input_y_var" type="data" format="tabular" label="Yearly variation dataset" help="Output from the 'Estimate temporal population evoution by species' tool."/>
        <param name="input_glob_tendencies" type="data" format="tabular" label="Global tendencies dataset" help="Output from the 'Estimate temporal population evoution by species' tool."/>
        <conditional name="settings">
            <expand macro="stoceps_advanced_params_select"/>
            <when value="advanced">
                <param name="sp_code" type="select" label="Filter species to exclude" help="Create a subsample by selecting the species codes you don't want to use." multiple="true" optional="true">
                    <options from_dataset="input_glob_tendencies">
                        <column name="value" index="1"/>
                        <filter type="unique_value" name="espece" column="1"/>
                    </options>
                    <sanitizer>
                        <valid initial="string.printable">
                            <remove value="&quot;"/>
                        </valid>
                    </sanitizer>
                </param>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data name="data_group" from_work_dir="Output/mainglm_group/donneesGroupes_mainglm_group.tabular" format="tabular" label="Glm - Group data on ${on_string}"/>
        <data name="year_var_group" from_work_dir="Output/mainglm_group/variationsAnnuellesGroupes_mainglm_group.tabular" format="tabular" label="Glm - Group yearly variations data on ${on_string}"/>
        <data name="glob_tend_group" from_work_dir="Output/mainglm_group/tendancesGlobalesGroupes_mainglm_group.tabular" format="tabular" label="Glm - Group tendencies on ${on_string}"/>
    </outputs>
    <tests>
    </tests>
    <help><![CDATA[
=================================================
STOC Estimate species population evolution
=================================================

**What it does**

Estimate temporal evolution of population per species
This script analyse the temporal evolution of species population and create graphical vizualisation.

Compute and plot evolution of species population by specialization group, using a glm model.


|

**Input description**

A tabular file with species count shaped and filtered with the STOCs 'Preprocess population data' and 'Filter species' tools. 

|

**Output**


Three tabular files are created, they describe global tendencies and yearly variations per groups.

|

**Source**

UnPublished script available at http://www.vigienature.fr/sites/vigienature/files/atoms/files/analysestoceps_0.zip
the first version written by Romain Lorrilliere.

Original script information:
- ExeMainGlmGalaxy.r

Script needs the followings inputs :
 - stoc or community data filtered with at least 4 columns: year, site, species, and abundance with 0. Corresponding to "observed" or predicted 0 abundance.
 May come from the tools "Preprocess population data for evolution trend analyzes" (ExemakeTableAnalyseGalaxy.r) followed by "Filter species with rare and low abundances" (ExeFilteringRareLowabundSPGalaxy.r).
 - species details file with name and indicator status file with at least 2 columns: the species name or species ID (found in the community data or in stoc data) and his status as indicator species
 - file that stocks functions : "FunctTrendSTOCGalaxy.r"


Arguments are :
 - spExclude: list of species (using the the species name or ID) that you want to exclude
 - assessIC : compute and show confidence interval in plots (TRUE / FALSE)
 - analysis custom id


How to execute, eg :
 # all files are available in github repo
 #Exec id=mainglm, return IC on plot, no species excluded
 $ Rscript ExeMainGlmGalaxy.r' Datafilteredfortrendanalysis.tabular tabSpecies.csv 'mainglm' '' 'TRUE' FunctTrendSTOCGalaxy.r


Outputs are created in an Output repo :
GLM gives 1 graph per species and 2 tables:
 - nameofspecies_id.png (one plot per species)
 - tendanceGlobalEspece_id.tabular
 - variationsAnnuellesEspece_id.tabular


R library needed
r-lme4  version 1.1.18.1
r-ggplot2  version 3.0.0
r-speedglm  version 0.3.2
r-arm  version 1.10.1
r-reshape  version 0.8.8
r-data.table  version 1.12.0
r-reshape2   version 1.4.3

  ]]></help>
</tool>
