<tool id="sdmpredictors_list_layers" name="SdmPredictors List Layers" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="21.05">
    <description>Terrestrial and marine predictors for species distribution modelling</description>
    <macros>
        <token name="@TOOL_VERSION@">0.2.15</token> 
        <token name="@VERSION_SUFFIX@">0</token>
    </macros>
    <requirements> 
        <requirement type="package" version="4.3.2">r-base</requirement>
        <requirement type="package" version="@TOOL_VERSION@">r-sdmpredictors</requirement>
        <requirement type="package" version="0.2_19">r-codetools</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
        
        Rscript
         '$__tool_directory__/script.R'
         #for $i, $s in enumerate($list_layers)
            ${s.choose_layer.input_layer}
            ${s.choose_layer.environement.terrestrial}
            ${s.choose_layer.environement.marine}
            ${s.choose_layer.environement.freshwater}
            ${s.choose_layer.advanced_options.monthly}
            ${s.choose_layer.advanced_options.version}
            #if str($s.choose_layer.input_layer) == 'layers_future'
                ${s.choose_layer.advanced_options.scenario}
                ${s.choose_layer.advanced_options.year}
            #end if
            #if str($s.choose_layer.input_layer) == 'layers_paleo'
                ${s.choose_layer.advanced_options.model_name}
                ${s.choose_layer.advanced_options.epoch}
                ${s.choose_layer.advanced_options.years_ago}
            #end if            
         #end for

         ]]></command>
    <inputs>
        <repeat name="list_layers" title="New layer list">
            <conditional name="choose_layer">
                <param name="input_layer" type="select" label="Choose Layer Time Frame">
                    <option value="layers_modern" selected="true">Modern Layer</option>
                    <option value="layers_future">Future Layer</option>
                    <option value="layers_paleo">Paleo Layer</option>
                </param>
                <when value="layers_modern">
                    <section name="environement" title= "environement layers" expanded="true" help="choose at least one environement to take layers from">
                        <param name ="terrestrial" type="boolean" 
                               label="terrestrial database" help="Ask for terrestrial data layers"/>
                        <param name ="marine" type="boolean" 
                               label="marine database" help="Ask for marine data layers"/>
                        <param name ="freshwater" type="boolean" 
                               label="freshwater" help="Ask for freshwater data layers"/>
                    </section>
                    <section name="advanced_options" title= "advanced option" expanded="false">
                        <param name ="monthly" type="boolean" checked="true" 
                               label="monthly" help="Ask for monthly data layers"/>
                        <param name ="version" type="text" value="0" 
                               label="version_layer" help="Ask for version of data layers"/>
                    </section>
                </when>
                <when value="layers_future">
                    <section name="environement" title= "environement layers" expanded="true" help="choose at least one environement to take layers from">
                        <param name ="terrestrial" type="boolean" 
                               label="terrestrial database" help="Ask for terrestrial data layers"/>
                        <param name ="marine" type="boolean" 
                               label="marine database" help="Ask for marine data layers"/>
                        <param name ="freshwater" type="boolean" 
                               label="freshwater" help="Ask for freshwater data layers"/>
                    </section>
                    <section name="advanced_options" title= "advanced option" expanded="false">
                        <param name ="monthly" type="boolean" checked="true" 
                               label="monthly" help="Ask for monthly data layers"/>
                        <param name ="version" type="text" value="0" 
                               label="version_layer" help="Ask for version of data layers"/>
                        <param name ="scenario" type="text" value="None" 
                               label="scenario" help="Ask for version of data layers"/>
                        <param name ="year" type="text" value="0" 
                               label="year" help="Ask for version of data layers"/>
                    </section>                   
                </when>
                <when value="layers_paleo">
                    <section name="environement" title= "environement layers" expanded="true" help="choose at least one environement to take layers from">
                        <param name ="terrestrial" type="boolean" 
                               label="terrestrial database" help="Ask for terrestrial data layers"/>
                        <param name ="marine" type="boolean" 
                               label="marine database" help="Ask for marine data layers"/>
                        <param name ="freshwater" type="boolean" 
                               label="freshwater" help="Ask for freshwater data layers"/>
                     </section>
                    <section name="advanced_options" title= "advanced option" expanded="false">
                        <param name ="monthly" type="boolean" checked="true" 
                               label="monthly" help="Ask for monthly data layers"/>
                        <param name ="version" type="text" value="0" 
                               label="version_layer" help="Ask for version of data layers"/>
                        <param name ="model_name" type="text" value="None" 
                               label="model name" help="Ask for version of data layers"/>
                        <param name ="epoch" type="text" value="None" 
                               label="epoch" help="Ask for version of data layers"/>
                        <param name ="years_ago" type="text" value="0" 
                               label="years ago" help="Ask for version of data layers"/>
                   </section>
                </when>
            </conditional>
        </repeat>
    </inputs>
    <outputs>
        <collection name="datasets_output" type="list"
            label="Datasets list">
        <discover_datasets pattern="__name_and_ext__" />
        </collection>
    </outputs>
    <tests>
        <test expect_num_outputs="1">
            <param name="terrestrial_input" value="FALSE"/>
            <param name="marine_input" value="TRUE"/>
        </test>
    </tests>
    <help><![CDATA[ 
.. class:: infomark

**What it does**

This tool takes the three-dimensional tensor file (in JSON format) produced by the 'Extract RMSD distance matrix data' tool and flattens it along the time axix to give a two-dimensional distance matrix.

Optionally, it also plots the distance matrix as a heatmap with matplotlib, performs hierarchical clustering with scipy, and plots the corresponding dendrogram.

_____


.. class:: infomark

**Input**

       - Three-dimensional tensor (JSON).
       - User selection of desired outputs, clustering method and other parameters

_____


.. class:: infomark

**Output**

       - Tabular file containing a two-dimensional N x N distance matrix, where N is the number of MD trajectories
       - Optional: a heatmap representing the distance matrix.
       - Optional: a tabular file containing the cluster linkage array produced by hierarchical clustering of the distance matrix
       - Optional: A dendrogram representing the hierarchical clustering.
        Usage: outils test SDMpredictors


        
+---------------+----------+----------+
|"     fdp     "|koukou    |   pauline|
+---------------+----------+----------+


table(4:3)



    ]]></help>
    <citations>
        <citation type="bibtex">@Manual{,
  title = {sdmpredictors: Species Distribution Modelling Predictor Datasets},
  author = {Samuel Bosch and Salvador Fernandez},
  year = {2023},
  note = {R package version 0.2.15},
  url = {http://lifewatch.github.io/sdmpredictors/},
}        
        </citation>
    </citations>
</tool>
