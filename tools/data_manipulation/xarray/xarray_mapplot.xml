<tool id="xarray_mapplot" name="NetCDF xarray map plotting" profile="20.05" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@">
    <description>Visualize netCDF variables on a geographical map</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <requirements>
        <requirement type="package" version="3">python</requirement>
        <requirement type="package" version="1.5.6">netcdf4</requirement>
        <requirement type="package" version="@TOOL_VERSION@">xarray</requirement>
        <requirement type="package" version="0.19.0">cartopy</requirement>
        <requirement type="package" version="3.4.2">matplotlib</requirement>
        <requirement type="package" version="1.2">cmcrameri</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
    mkdir output_dir &&
    mkdir -p `pwd`/mlp_tmpdir &&
    MPLCONFIGDIR=`pwd`/mlp_tmpdir &&
    echo "Galaxy xarray version @TOOL_VERSION@" > output_dir/version.txt &&
    python '$__tool_directory__/xarray_mapplot.py' '$input' '$var'
    #if $condi_datetime.datetime=="yes"
         --time="$condi_datetime.time_values"
    #end if
         --latitude='$lat_dim'
         --longitude='$lon_dim'
    #if $colorbar_label
         --label='$colorbar_label'
    #end if
    #if $title
         --title=$title
    #end if
    #if $cmap
         --cmap='$cmap'
    #end if
    #if $proj
         --proj='$proj'
    #end if
    #if $land
         --land='$land'
    #end if
    #if $ocean
         --ocean='$ocean'
    #end if
    #if $coastline
         --coastline='$coastline'
    #end if
    #if $borders
         --borders='$borders'
    #end if
    #if $threshold
         --threshold='$threshold'
    #end if
    #if $range
         --range='$range'
    #end if
    #if $xlim
         --xlim='$xlim'
    #end if
    #if $ylim
         --ylim='$ylim'
    #end if
    #if $shift
         --shift
    #end if
         --output plot.png
         --verbose &&
    mv *.png output_dir
    ]]></command>
    <inputs>
        <param type="data" name="input" label="Input netcdf file" format="netcdf"/>
        <param type="data" label="Tabular of variables" name="var_tab" format="tabular" help="Select the tabular file which summarize the available variables and dimensions."/>
        <param name="var" type="select" label="Choose the variable to plot">
            <options from_dataset="var_tab">
                <column name="name" index="0"/>
                <column name="value" index="0"/>
            </options>
        </param>
        <param name="lat_dim" type="select" label="Name of latitude coordinate" >
            <options from_dataset="var_tab">
                <column name="value" index="0"/>
            </options>
        </param>
        <param name="lon_dim" type="select" label="Name of longitude coordinate" >
            <options from_dataset="var_tab">
                <column name="value" index="0"/>
            </options>
        </param>
        <conditional name="condi_datetime">
            <param name="datetime" type="select" label="Datetime selection" help="Use this option when your dataset contains multiple times/dates">
                <option value="no">No</option>
                <option value="yes">Yes</option>
            </param>
            <when value="no"></when>
            <when value="yes">
                <param type="data" label="Tabular of time values" name="time_tab" format="tabular" help="File containing time values."/>
                <param name="time_values" type="select" multiple="true" label="Choose the times to plot">
                    <options from_dataset="time_tab">
                        <column name="name" index="1"/>
                        <column name="value" index="0"/>
                    </options>
                </param>
            </when>
       </conditional>
        <param name="xlim" type="text" optional="true" label="longitudes values 'lonW,lonE' for limited geographical area (optional and only available with some projections)" />
        <param name="ylim" type="text" value=""  optional="true" label="latitudes values 'latS,latN' for limited geographical area (optional and only available with some projections)" />
        <param name="shift" type="select"  optional="true" display="radio" label="Shift longitudes [0,360] --> [-180,180]"> 
             <option value="" selected="true">No</option>
             <option value="Yes">Yes</option>
        </param>
        <param name="range" type="text" optional="true" label="Range of values for plotting e.g. minimum value abd maximum value (minval,maxval) (optional)" />
        <param name="threshold" type="float"  optional="true" label="Do not plot values below this threshold (optional)" />
        <param name="borders" type="float" optional="true" label="Add country borders with alpha value [0-1] (optional)" />
        <param name="coastline" type="float" optional="true" label="Add coastline with alpha value [0-1] (optional)" />
        <param name="ocean" type="float" optional="true" label="Add ocean with alpha value [0-1] (optional)" />
        <param name="land" type="float" optional="true" label="Add land with alpha value [0-1] (optional)" />
        <param name="title" type="text" optional="true" label="Specify plot title (optional)" />
        <param name="colorbar_label" type="text"  optional="true" label="Set a label for colormap (optional)" />
        <param name="cmap" type="select" optional="true" label="Specify which colormap to use for plotting (optional)">
            <option value="cm.batlow">batlow</option>
            <option value="cm.batlowW">batlowW</option>
            <option value="cm.batlowK">batlowK</option>
            <option value="cm.devon">devon</option>
            <option value="cm.davos">davos</option>
            <option value="cm.oslo">oslo</option>
            <option value="cm.lapaz">lapaz</option>
            <option value="cm.acton">acton</option>
            <option value="cm.lajolla">lajolla</option>
            <option value="cm.bilbao">bilbao</option>
            <option value="cm.grayC">grayC</option>
            <option value="cm.tokyo">tokyo</option>
            <option value="cm.turku">turku</option>
            <option value="cm.bamako">bamako</option>
            <option value="cm.nuuk">nuuk</option>
            <option value="cm.hawaii">hawaii</option>
            <option value="cm.buda">buda</option>
            <option value="cm.imola">imola</option>
            <option value="cm.broc">broc</option>
            <option value="cm.lisbon">lisbon</option>
            <option value="cm.roma">roma</option>
            <option value="cm.cork">cork</option>
            <option value="cm.tofino">tofino</option>
            <option value="cm.bam">bam</option>
            <option value="cm.vik">vik</option>
            <option value="cm.berlin">berlin</option>
            <option value="cm.vanimo">vanimo</option>
            <option value="cm.oleron">oleron</option>
            <option value="cm.bukavu">bukavu</option>
            <option value="cm.fes">fes</option>
            <option value="cm.romaO">romaO</option>
            <option value="cm.bamO">bamO</option>
            <option value="cm.brocO">brocO</option>
            <option value="cm.corkO">corkO</option>
            <option value="cm.vikO">vikO</option>
            <option value="cm.batlow_r">batlow_r</option>
            <option value="cm.batlowW_r">batlowW_r</option>
            <option value="cm.batlowK_r">batlowK_r</option>
            <option value="cm.devon_r">devon_r</option>
            <option value="cm.davos_r">davos_r</option>
            <option value="cm.oslo_r">oslo_r</option>
            <option value="cm.lapaz_r">lapaz_r</option>
            <option value="cm.acton_r">acton_r</option>
            <option value="cm.lajolla_r">lajolla_r</option>
            <option value="cm.bilbao_r">bilbao_r</option>
            <option value="cm.grayC_r">grayC_r</option>
            <option value="cm.tokyo_r">tokyo_r</option>
            <option value="cm.turku_r">turku_r</option>
            <option value="cm.bamako_r">bamako_r</option>
            <option value="cm.nuuk_r">nuuk_r</option>
            <option value="cm.hawaii_r">hawaii_r</option>
            <option value="cm.buda_r">buda_r</option>
            <option value="cm.imola_r">imola_r</option>
            <option value="cm.broc_r">broc_r</option>
            <option value="cm.lisbon_r">lisbon_r</option>
            <option value="cm.roma_r">roma_r</option>
            <option value="cm.cork_r">cork_r</option>
            <option value="cm.tofino_r">tofino_r</option>
            <option value="cm.bam_r">bam_r</option>
            <option value="cm.vik_r">vik_r</option>
            <option value="cm.berlin_r">berlin_r</option>
            <option value="cm.vanimo_r">vanimo_r</option>
            <option value="cm.oleron_r">oleron_r</option>
            <option value="cm.bukavu_r">bukavu_r</option>
            <option value="cm.fes_r">fes_r</option>
            <option value="cm.romaO_r">romaO_r</option>
            <option value="cm.bamO_r">bamO_r</option>
            <option value="cm.brocO_r">brocO_r</option>
            <option value="cm.corkO_r">corkO_r</option>
            <option value="cm.vikO_r">vikO_r</option>
            <option value="Accent">Accent</option>
            <option value="Blues">Blues</option>
            <option value="BrBG">BrBG</option>
            <option value="BuGn">BuGn</option>
            <option value="BuPu">BuPu</option>
            <option value="CMRmap">CMRmap</option>
            <option value="Dark2">Dark2</option>
            <option value="GnBu">GnBu</option>
            <option value="Greens">Greens</option>
            <option value="Greys">Greys</option>
            <option value="OrRd">OrRd</option>
            <option value="Oranges">Oranges</option>
            <option value="PRGn">PRGn</option>
            <option value="Paired">Paired</option>
            <option value="Pastel1">Pastel1</option>
            <option value="Pastel2">Pastel2</option>
            <option value="PiYG">PiYG</option>
            <option value="PuBu">PuBu</option>
            <option value="PuBuGn">PuBuGn</option>
            <option value="PuOr">PuOr</option>
            <option value="PuRd">PuRd</option>
            <option value="Purples">Purples</option>
            <option value="RdBu">RdBu</option>
            <option value="RdGy">RdGy</option>
            <option value="RdPu">RdPu</option>
            <option value="RdBu_r">RdBu_r</option>
            <option value="RdGy_r">RdGy_r</option>
            <option value="RdPu_r">RdPu_r</option>
            <option value="RdYlBu">RdYlBu</option>
            <option value="RdYlGn">RdYlGn</option>
            <option value="Reds">Reds</option>
            <option value="Set1">Set1</option>
            <option value="Set2">Set2</option>
            <option value="Set3">Set3</option>
            <option value="Spectral">Spectral</option>
            <option value="Wistia">Wistia</option>
            <option value="YlGn">YlGn</option>
            <option value="YlGnBu">YlGnBu</option>
            <option value="YlOrBr">YlOrBr</option>
            <option value="YlOrRd">YlOrRd</option>
            <option value="afmhot">afmhot</option>
            <option value="autumn">autumn</option>
            <option value="binary">binary</option>
            <option value="bone">bone</option>
            <option value="brg">brg</option>
            <option value="bwr">bwr</option>
            <option value="cool">cool</option>
            <option value="coolwarm" selected="true">coolwarm</option>
            <option value="copper">copper</option>
            <option value="cubehelix">cubehelix</option>
            <option value="flag">flag</option>
            <option value="gist_earth">gist_earth</option>
            <option value="gist_gray">gist_gray</option>
            <option value="gist_heat">gist_heat</option>
            <option value="gist_ncar">gist_ncar</option>
            <option value="gist_rainbow">gist_rainbow</option>
            <option value="gist_stern">gist_stern</option>
            <option value="gist_yarg">gist_yarg</option>
            <option value="gnuplot">gnuplot</option>
            <option value="gnuplot2">gnuplot2</option>
            <option value="gray">gray</option>
            <option value="hot">hot</option>
            <option value="hsv">hsv</option>
            <option value="jet">jet</option>
            <option value="nipy_spectral">nipy_spectral</option>
            <option value="ocean">ocean</option>
            <option value="pink">pink</option>
            <option value="prism">prism</option>
            <option value="rainbow">rainbow</option>
            <option value="seismic">seismic</option>
            <option value="spring">spring</option>
            <option value="summer">summer</option>
            <option value="tab10">tab10</option>
            <option value="tab20">tab20</option>
            <option value="tab20b">tab20b</option>
            <option value="tab20c">tab20c</option>
            <option value="terrain">terrain</option>
            <option value="winter">winter</option>
        </param>
        <param name="proj" type="text" optional="true" label='Specify the projection (proj4) on which we draw e.g. {"proj":"PlateCarree"} with double quote (optional)'>
            <sanitizer>
                <valid initial="string.ascii_letters,string.digits,string.punctuation,string.whitespace">
                    <add value="{" />
                    <add value="}" />
                </valid>
            </sanitizer>
        </param>

    </inputs>
    <outputs>
        <collection type="list" name="output_dir" label="Map plots">
            <discover_datasets pattern="__name_and_ext__" directory="output_dir"/>
        </collection>
    </outputs>
    <tests>
        <test>
             <param name="input" value="dataset-ibi-reanalysis-bio-005-003-monthly-regulargrid_1510914389133.nc"/>
             <param name="var" value="nh4"/>
             <param name="var_tab" value="var_tab_dataset-ibi"/>
             <param name="lat_dim" value="latitude"/>
             <param name="lon_dim" value="longitude"/>
             <conditional name="condi_datetime">
                 <param name="datetime" value="yes"/>
                 <param name="time_tab" value="time.tabular"/>
                 <param name="time_values" value="50"/>
             </conditional>
             <param name="cmap" value="cm.devon_r"/>   
             <param name="proj" value='{"proj":"PlateCarree"}'/>    
             <param name="land" value="0.1"/>                         
             <param name="ocean" value="0.1"/>                         
             <param name="coastline" value="0.2"/>                         
             <param name="borders" value="0.5"/>                         
             <output_collection name="output_dir" type="list" count="2">
                 <element name="plot_time50" ftype='png' file="dataset-ibi-reanalysis-bio-005-003-monthly-regulargrid_1510914389133_time50.png"/>
                 <element name="version" ftype='txt' file="version.txt"/>
             </output_collection>
        </test>
        <test>
             <param name="input" value="dataset-ibi-reanalysis-bio-005-003-monthly-regulargrid_1510914389133.nc"/>
             <param name="var" value="chl"/>
             <param name="var_tab" value="var_tab_dataset-ibi"/>
             <param name="lat_dim" value="latitude"/>
             <param name="lon_dim" value="longitude"/>
             <conditional name="condi_datetime">
                 <param name="datetime" value="yes"/>
                 <param name="time_tab" value="time.tabular"/>
                 <param name="time_values" value="0,1"/>
             </conditional>
             <param name="cmap" value="Greens"/>   
             <param name="proj" value='{"proj":"PlateCarree"}'/>    
             <param name="land" value="0.1"/>                         
             <param name="ocean" value="0.1"/>                         
             <param name="coastline" value="0.2"/>                         
             <param name="borders" value="0.5"/>                         
             <output_collection name="output_dir" type="list" count="3">
                 <element name="plot_time0" ftype="png" file="dataset-ibi-reanalysis-bio-005-003-monthly-regulargrid_1510914389133_time0.png"/>
                 <element name="plot_time1" ftype="png" file="dataset-ibi-reanalysis-bio-005-003-monthly-regulargrid_1510914389133_time1.png"/>
                 <element name="version" ftype="txt" file="version.txt"/>
             </output_collection>
                                                                                                                
        </test>
    </tests>
    <edam_topics>
       <edam_topic>topic_0610</edam_topic>
       <edam_topic>topic_3050</edam_topic>
    </edam_topics>
    <help><![CDATA[
**What it does**

This tool plot a variable on a geographical map. It must be a 2D variable (latitude, longitude) and eventually with 
and additional time dimension (specific time to plot should then be selected).

The output is a collection of plots (png format).

-------------------------------------------------

The xarray select tool can be used after the xarray Info and xarray coord.
    ]]></help>
</tool>
