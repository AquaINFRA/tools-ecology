<tool id="ecology_presence_abs_abund" name="Presence-absence and abundance" version="@VERSION@" profile="20.01">
    <description>in a spatial environment</description>
    <macros>
        <import>macro.xml</import>
    </macros>
    <expand macro="Explo_requirements">
        <requirement type="package" version="2.5_7">r-vegan</requirement>
    </expand>
    <command detect_errors="exit_code"><![CDATA[
        Rscript
            '$__tool_directory__/graph_pres_abs_abund.r'
            '$input'
            '$colnames'
            #if $method.type=='abund':
              'TRUE'
              'FALSE'
              'FALSE'
              '$method.latitude'
              '$method.longitude'
              '$method.individual'
              ''
              ''
              '$method.species'
            #elif $method.type=='pres_abs':
              'FALSE'
              'TRUE'
              'FALSE'
              ''
              ''
              ''
              '$method.site'
              ''
              '$method.species'
            #else:
              'FALSE'
              'FALSE'
              'TRUE'
              ''
              ''
              ''
              ''
              '$method.number'
              '$method.species'
            #end if
            '$abundance'
        ]]>
    </command>
    <inputs>
        <expand macro="explo_input"/>
        <conditional name="method">
            <param name="type" type="select" label="Variables presence, absence and abundance" display="radio">
                <option value="abund">Abundance map in the environment </option>
                <option value="pres_abs">Presence and absence count of taxon according to their locations</option>
                <option value="rare">Rarefaction curve of species</option>
            </param>
            <when value="abund">
                <param name="latitude" label="Select column containing latitudes " type="data_column" data_ref="input" numerical="true" use_header_names="true"/>
                <param name="longitude" label="Select column containing longitudes" type="data_column" data_ref="input" numerical="true" use_header_names="true"/>
                <param name="individual" type="text" label="What do you study in this analysis ?" help="Simply allows you to use any name you want in your plot's title (ex : ''Bats'', ''Chiroptera'')"/>
                <param name="species" label="Select column containing taxon " type="data_column" data_ref="input" numerical="false" use_header_names="true"/>
            </when>
            <when value="pres_abs">
                <param name="site" label="Select column containing sites " type="data_column" data_ref="input" use_header_names="true"/>
                <param name="species" label="Select column containing species " type="data_column" data_ref="input" numerical="false" use_header_names="true"/>
            </when>
            <when value="rare">
                <param name="number" label="Size of subsamples" type="text" help="Rarefaction curves are calculated over random subsamples, you can choose the size you want depending on your data and the analysis you need. Should be smaller than the size of your community"/>
                <param name="species" label="Select column containing species " type="data_column" data_ref="input" numerical="false" use_header_names="true"/>
            </when>
        </conditional>
        <param name="abundance" label="Select column containing abundances " type="data_column" data_ref="input" numerical="true" use_header_names="true"/>
    </inputs>
    <outputs>
        <data name="output_abund" from_work_dir="Data_abund.txt" format="txt" label="Data used">
            <expand macro="explo_filter_abund"/>
        </data>
        <data name="output_pres_abs" from_work_dir="Locations.txt" format="txt" label="Locations used">
            <expand macro="explo_filter_pres_abs"/>
        </data>
        <data name="output_rare" from_work_dir="Rare.tabular" format="tabular" label="Rare indice">
            <expand macro="explo_filter_rare"/>
        </data>
        <collection type="list" name="plots">
            <discover_datasets pattern="(?P&lt;designation&gt;.+)\.png" visible="false" format="png"/>
        </collection>
    </outputs>
    <tests>
        <test>
            <param name="input" value="Reel_life_survey_fish_modif2.tabular"/>
            <param name="colnames" value="true"/>
            <conditional name="method">
                <param name="abund" value="true"/>
                <param name="latitute" value="9"/>
                <param name="longitude" value="10"/>
                <param name="individual" value="fishes"/>
                <param name="species" value="15"/>
            </conditional>
            <param name="abundance" value="18"/>
            <output name="output_abund">
                <assert_contents>
                    <has_n_lines n="12"/>
                </assert_contents>
            </output>
            <output_collection name="plots" type="list" count="1">
                <element name="mappy" ftype="png">
                    <assert_contents>
                        <has_text text="PNG"/>
                    </assert_contents>
                </element>
            </output_collection>
        </test>
    </tests>
    <expand macro="topic"/>
    <help><![CDATA[
======================================================
Computes the presence absence and abundance of species 
======================================================

- Show the abundance according to the location 
- Show if a species is present or not and in which proportion
- Plot the rarefaction curve

==================
Maps the abundance 
==================


**What it does**

This tool computes the abundances of species according to there locations data:

- Maps the abundance

**Input description**

A tabular file with observation data. Must at least contain three columns
which associate abundance, latitude and longitude or 'abundance', 'latitude' and 'longitude' with species ID.

+----------+-----------+--------------+------------+
| latitude | longitude | species.code |   number   |
+==========+===========+==============+============+
| lat      |long       |   speciesID  |      4     |
+----------+-----------+--------------+------------+
|  ...     |    ...    |      ...     |     ...    |
+----------+-----------+--------------+------------+

**Output**

A png file with every abundance dots for each location such as the image following

.. image::envi_abond.png


=====================================
Count the presence absence of species
=====================================

**What it does**

This tool computes the number of appearances of each specie, it counts it presence absence, according to a variable (location for instance):

- Computes one graph

**Input description**

A tabular file with observation data. Must at least contain two columns
which associate species with a variable.

+--------------+------------+------------+
| species.code |  variable  |    number  |
+==============+============+============+
|   speciesID  |    site    |      4     |
+--------------+------------+------------+
|      ...     |     ...    |     ...    |
+--------------+------------+------------+


**Output**

A  png file with one graphic showing barplots according to the variable divided in multiple colors according to species.

.. image::fish_test.png


=====================
Plots the rarefaction
=====================

**What it does**

This tool computes the rarefaction curves of species:

- Computes one or multiple graphs

**Input description**

A tabular file with observation data. Must at least contain two columns
which associate abundance and species ID.
And one numeric value for the rarefaction indice must be entered

+--------------+------------+
| species.code |   number   |
+==============+============+
|   speciesID  |      4     |
+--------------+------------+
|      ...     |     ...    |
+--------------+------------+

**Output**

A png file with one or multiple graphs showing the rarefaction curves for each species according to one rarefaction indice that you chose.
|

**HELP**

Warning : If there are more than 30 species in your data you will have one graph for each species and not all the curves on one graph.

    ]]>    </help>
    <expand macro="book_bibref"/>

</tool>
