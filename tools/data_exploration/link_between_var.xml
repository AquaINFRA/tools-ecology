<tool id="ecology_link_between_var" name="Variables exploration" version="@VERSION@" profile="20.01">
    <description>Shows interaction, correlation, colinearity and variance inflation factor (vif)</description>
    <macros>
        <import>macro.xml</import>
    </macros>
    <requirements>
        <requirement type="package" version="4.1">r-base</requirement>
        <requirement type="package" version="1.1.1">r-cowplot</requirement>
        <requirement type="package" version="3.3.3">r-ggplot2</requirement>
        <requirement type="package" version="2.1.2">r-ggally</requirement>
        <requirement type="package" version="1.0.7">r-faraway</requirement>
        <requirement type="package" version="3.0_10">r-car</requirement>
        <requirement type="package" version="1.0.5">r-dplyr</requirement>
        <requirement type="package" version="0.1.3">r-ggcorrplot</requirement>        
        <requirement type="package" version="2.4">r-factominer</requirement>
        <requirement type="package" version="1.0.7">r-factoextra</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
        Rscript
            '$__tool_directory__/graph_link_var.r'
            '$input'
            '$colnames'
            #if $method.explo_type=='collinearity':
              'TRUE'
              'FALSE'
              'FALSE'
              'FALSE'
              'FALSE'
              '$method.species'
              '$method.columns'
              ''
              ''
              ''
            #elif $method.explo_type=='vif':
              'FALSE'
              'TRUE'
              'FALSE'
              'FALSE'
              'FALSE'
              ''
              '$method.columns'
              ''
              ''
              ''
            #elif $method.explo_type=='pca':
              'FALSE'
              'FALSE'
              'TRUE'
              'FALSE'
              'FALSE'
              ''
              '$method.columns'
              ''
              ''
              ''
            #elif $method.explo_type=='interr':
              'FALSE'
              'FALSE'
              'FALSE'
              'TRUE'
              'FALSE'
              '$method.species'
              ''
              '$method.variable'
              '$method.variable2'
              '$method.variable3'
            #else:
              'FALSE'
              'FALSE'
              'FALSE'
              'FALSE'
              'TRUE'
              ''
              ''
              '$method.variable'
              ''
              ''
            #end if
            
        ]]>
        </command>
        <inputs>
            <expand macro="explo_input"/>
            <conditional name="method">
                <param name="explo_type" type="select" label="Variables links exploration">
                    <option value="collinearity">Collinearity between selected numerical variables for each species</option>
                    <option value="vif">Variance inflation factor (vif) on selected numerical variables</option>
                    <option value="pca">Principal component analysis (pca) on selected numerical variables</option>
                    <option value="interr">Interactions between 2 selected numerical variables</option>
                    <option value="autocorr">Autocorrelation of one selected numerical variable</option>
                </param>
                <when value="collinearity">
                    <param name="species" type="data_column" data_ref="input" numerical="False" label="Select column containing species for collinearity"/>
                    <param name="columns" type="data_column" data_ref="input" numerical="True" multiple="True" label="Select columns containing numerical values"/>
                </when>
                <when value="vif">
                    <param name="columns" type="data_column" data_ref="input" numerical="True" multiple="True" label="Select columns containing numerical values"/>
                </when>
                <when value="pca">
                    <param name="columns" type="data_column" data_ref="input" numerical="True" multiple="True" label="Select columns containing numerical values" />
                </when>
                <when value="interr">
                    <param name="variable" type="data_column" data_ref="input" numerical="True" label="Select column containing numerical values" />
                    <param name="variable2" type="data_column" data_ref="input" numerical="True" label="Select column containing numerical values" />
                    <param name="species" type="data_column" data_ref="input" numerical="False" label="Select column containing species" help="This parameter allows you to divide your scatterplot according to species"/>
                    <param name="variable3" type="data_column" data_ref="input" label="Select column" help="This parameter allows you to divide your scatterplot once more"/>
                </when>
                <when value="autocorr">
                    <param name="variable" type="data_column" data_ref="input" numerical="True" label="Select column containing numerical values"/>
                </when>
            </conditional>
        </inputs>
        <outputs>
            <data name="output_coli" from_work_dir="Data.txt" format="txt" label="Missing species">
                <expand macro="explo_filter_colli"/>
            </data>
            <data name="output_acp" from_work_dir="valeurs.txt" format="txt" label="Eigen values">
                <expand macro="explo_filter_pca"/>
            </data>
            <data name="output_vif" from_work_dir="vif.tabular" format="tabular" label="Your VIF tabular">
                <expand macro="explo_filter_vif"/>
            </data>
            <data name="output_corr" from_work_dir="corr.tabular" format="tabular" label="Correlation matrix">
                <expand macro="explo_filter_vif"/>
            </data>
            <data name="output_interr" from_work_dir="Species.txt" format="txt" label="Species in data">
                <expand macro="explo_filter_interr"/>
            </data>
            <data name="output_autocorr" from_work_dir="acf.txt" format="txt" label="Acf table">
                <expand macro="explo_filter_autocorr"/>
            </data>
            <collection type="list" name="plots">
                <discover_datasets pattern="(?P&lt;designation&gt;.+)\.png" visible="false" format="png"/>
                <filter> method['type'] != 'vif'</filter>
            </collection>
        </outputs>
        <tests>
            <test>
                <param name="input" value="Reel_life_survey_fish_modif2.tabular"/>
                <param name="colnames" value="true"/>
                <param name="colli" value="true"/>
                <param name="vif" value="false"/>
                <param name="pca" value="false"/>
                <param name="interr" value="false"/>
                <param name="autcorr" value="false"/>
                <param name="species" value="15"/>
                <param name="columns" value="12,17,18"/>
                <output name="output_coli" value="Missing_species.txt"/>
                <output_collection name="plots" type="list" count="3">
                    <element name="collinarity_of_Blenniidae" ftype="png">
                        <assert_contents>
                            <has_text text="PNG"/>
                        </assert_contents>
                    </element>
                    <element name="collinarity_of_Gobiidae" ftype="png">
                        <assert_contents>
                            <has_text text="PNG"/>
                        </assert_contents>
                    </element>
                    <element name="collinarity_of_Tripterygiidae" ftype="png">
                        <assert_contents>
                            <has_text text="PNG"/>
                        </assert_contents>
                    </element>
                </output_collection>
            </test>
        </tests>
        <expand macro="topic"/>
        <help><![CDATA[
=================================
Calculate links between variables
=================================

- Show the collinearity among the covariates
- Plot a PCA
- Compute the variance inflation factor (VIF)
- Show if there is auto-correlation
- Show the interractions between variables


===========================
Calculate the collinearity
===========================

**What it does**

This tool shows if multiple numerical variables are colinear or not with one another:

- One graph or multiple graphs.

**Input description**

A tabular file with observation data. Must at least contain three columns
which associate species and multiple numerical variable.

+-------------+------------+---------------+
|   number1   |   number2  | species.code  |
+=============+============+===============+
|      2      |      4     |   speciesID   |
+-------------+------------+---------------+
|     ...     |     ...    |      ...      |
+-------------+------------+---------------+

**Output**

A  png file with one graph containing multiple correlation plots and the correlation value between each variables.

|

**HELP**

Warning : When there are more than 3 species in the data this tool shows a graph for each specie.


=================
Computes the VIF
=================


**What it does**

This tool calculates th variance inflation factor according to 2 numerical variables:

- Computes the VIF

**Input description**

A tabular file with observation data. Must at least contain three columns
which associate at least 2 numerical variables.

+----------+-----------+
| number 1 |  number 2 |
+==========+===========+
|    4     |     2     |
+----------+-----------+
|  ...     |    ...    |
+----------+-----------+


**Output**

Two tabulars one containing the VIF :

- The VIF measures how much the behavior (variance) of an independent variable is influenced, or inflated, by its interaction/correlation with the other independent variables.

- A large VIF on an independent variable indicates a highly collinear relationship to the other variable that should be considered or adjusted for in the structure of the model and selection of independent variable.

The other tabular contains the correlation marix.


===========
Plots a PCA 
===========

**What it does**

This tool computes a principal composante analisys :

- Computes 2 graphs

**Input description**

A tabular file with observation data. 
whith numerical variables.

+----------+-----------+--------------+
|variable 1| variable 2| species.code |
+==========+===========+==============+
|    2     |     4     |   speciesID  |
+----------+-----------+--------------+
|  ...     |    ...    |      ...     |
+----------+-----------+--------------+

**Output**

A png file with 2 graphs. The first one is a showing a circle with the correlation between variables :

- The poisitively correlated variables are grouped together.

- The negatively ones are on opposite sides of the graph's origin.

- the distance between the variables and th origin calculates the quality of the representation of the variables. The variables far from the orignin are well represented by the PCA.  

The second graph is the oe bout the quality :

- A high cos2 indicates a good representation of the variable. In this case, the variable is near the circumference of the correlation circle.

- A low cos2 indicates that the variable is not perfectly represented. In this case, the variable is near the center of the circle.

=============================================
Calculate the interactions between variables
=============================================

**What it does**

This tool computes the interactions between variables :
- Computes multiple scatterplots

**Input description**

A tabular file with observation data. Must at least contain four columns
which associate two numerical variables and two other variables.

+----------+-----------+--------------+------------+
|  number1 | variable  | species.code |   number2  |
+==========+===========+==============+============+
|    2     |    var    |   speciesID  |      4     |
+----------+-----------+--------------+------------+
|  ...     |    ...    |      ...     |     ...    |
+----------+-----------+--------------+------------+

**Output**

A  png file with multiple graphs showing the interactions between two variables.
|
 
.. image::scattplot.png

=============================
Calculate the Autocorrelation
=============================

**What it does**

This tool computes the autocorrelation of a numerical variable:

- Computes a graph

**Input description**

A tabular file with observation data. Must at least contain three columns
whith one numerical variable

+------------+
|   number   |
+============+
|      4     |
+------------+
|     ...    |
+------------+

**Output**

A png file with one graph showing if we have autocorrelation for a variable, if so the bars of the histogram are between the dashed lines (95% confidence intervalle without white noise) as shwon on the following image.


.. image::Autocorr.png

    ]]></help>
    <expand macro="explo_bibref"/>  
    <!--<expand macro="book_bibref"/>-->    
</tool>
